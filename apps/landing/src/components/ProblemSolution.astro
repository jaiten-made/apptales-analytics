---
/** Problem and Solution section component */
interface Props {
  className?: string;
}

const { className = "" } = Astro.props as Props;

// Accordion data
const accordionItems = [
  {
    id: "understand-experiences",
    title: "Transform Experiences into Insights",
    description:
      "See where your users struggle in their journeys with Apptales visual flow charts for clear actionable insights.",
    video: "/videos/understand-experiences.mp4",
    icon: "ðŸ’¡",
  },
  {
    id: "ideal-journey",
    title: "See How Reality Compares to Your Vision",
    description:
      "Define your ideal journey, record your success path, and discover where real users diverge with insights drawn from user-centric data.",
    video: "/videos/define-ideal-journey.mp4",
    icon: "ðŸŽ¥",
  },
];

// Helper to check if URL is a video
const isVideo = (url: string) => url.match(/\.(mp4|webm|ogg)(\?.*)?$/i);
---

<!-- make section a flex column and fill viewport -->
<section class="py-16 px-8 bg-white min-h-screen flex flex-col">
  <!-- make container stretch to fill available space -->
  <div class="container mx-auto max-w-8xl flex-1 flex flex-col">
    <!-- Main Section Title -->
    <div class="text-center mb-12">
      <h2 class="text-4xl font-bold text-gray-900 mb-4">
        Stop Guessing How Users Experience Your Product
      </h2>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        Identify success and failure points in your user journeys.
      </p>
    </div>

    <!-- Accordion and Image Section -->
    <!-- main content should take remaining space under the header -->
    <div class="flex gap-12 items-stretch flex-1">
      <!-- Accordion Section -->
      <div class="flex-1 space-y-4">
        {
          accordionItems.map((item, index) => (
            <div class="accordion-item border border-gray-200 rounded-lg overflow-hidden ">
              <button
                class="accordion-trigger w-full text-left p-6 bg-gray-50 hover:bg-gray-100 transition-colors duration-200 flex items-center justify-between"
                data-accordion-target={item.id}
                data-media-index={index}
                aria-expanded={index === 0 ? "true" : "false"}
              >
                <div class="flex items-center space-x-3">
                  <span class="text-2xl">{item.icon}</span>
                  <h3 class="text-lg font-semibold text-gray-900">
                    {item.title}
                  </h3>
                </div>
                <svg
                  class="accordion-chevron w-5 h-5 text-gray-500 transform transition-transform duration-200"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>
              <div
                class={`accordion-content overflow-hidden transition-all duration-300 ${index === 0 ? "max-h-96" : "max-h-0"}`}
                id={item.id}
              >
                <div class="p-6 bg-white border-t border-gray-200">
                  <p class="text-gray-700 leading-relaxed">
                    {item.description}
                  </p>
                </div>
              </div>
            </div>
          ))
        }
      </div>

      <!-- Image Section -->
      <div class="flex-[1.5] flex">
        <div
          class="bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg overflow-hidden shadow-lg flex flex-col flex-1"
        >
          <!-- media wrapper must be flex-1 so absolutely positioned media can fill it -->
          <div class="w-full flex-1 relative overflow-hidden bg-gray-50">
            {
              accordionItems.map((item, index) => (
                <>
                  {isVideo(item.video) ? (
                    <video
                      class={`accordion-media p-4 w-full h-full object-contain transition-opacity duration-300 absolute inset-0 ${index === 0 ? "opacity-100 z-10" : "opacity-0 z-0"}`}
                      data-media-index={index}
                      muted
                      playsinline
                      loop
                      autoplay={index === 0}
                      aria-hidden="true"
                    >
                      <source src={item.video} type="video/mp4" />
                    </video>
                  ) : (
                    <img
                      class={`accordion-media w-full h-full object-contain transition-opacity duration-300 absolute inset-0 ${index === 0 ? "opacity-100 z-10" : "opacity-0 z-0"}`}
                      data-media-index={index}
                      src={item.video}
                      loading="lazy"
                    />
                  )}
                </>
              ))
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  // Accordion functionality
  const accordionTriggers = document.querySelectorAll(
    ".accordion-trigger"
  ) as NodeListOf<HTMLButtonElement>;
  const allMedia = document.querySelectorAll(
    ".accordion-media"
  ) as NodeListOf<HTMLElement>;
  const allCaptions = document.querySelectorAll(
    ".accordion-caption"
  ) as NodeListOf<HTMLElement>;

  accordionTriggers.forEach((trigger, index) => {
    trigger.addEventListener("click", () => {
      const targetId = trigger.dataset.accordionTarget;
      const mediaIndex = trigger.dataset.mediaIndex;
      const targetContent = document.getElementById(
        targetId!
      ) as HTMLDivElement;
      const chevron = trigger.querySelector(
        ".accordion-chevron"
      ) as HTMLElement;
      const isExpanded = trigger.getAttribute("aria-expanded") === "true";

      // Close all other accordions
      accordionTriggers.forEach((otherTrigger, otherIndex) => {
        if (otherIndex !== index) {
          const otherId = otherTrigger.dataset.accordionTarget;
          const otherContent = document.getElementById(
            otherId!
          ) as HTMLDivElement;
          const otherChevron = otherTrigger.querySelector(
            ".accordion-chevron"
          ) as HTMLElement;

          otherTrigger.setAttribute("aria-expanded", "false");
          if (otherContent) {
            otherContent.style.maxHeight = "0";
          }
          if (otherChevron) {
            otherChevron.style.transform = "rotate(0deg)";
          }
        }
      });

      // Toggle current accordion
      if (!isExpanded) {
        trigger.setAttribute("aria-expanded", "true");
        if (targetContent) {
          targetContent.style.maxHeight = targetContent.scrollHeight + "px";
        }
        if (chevron) {
          chevron.style.transform = "rotate(180deg)";
        }

        // Show corresponding media and caption
        allMedia.forEach((media) => {
          const isActive = media.dataset.mediaIndex === mediaIndex;
          media.style.opacity = isActive ? "1" : "0";
          media.style.zIndex = isActive ? "10" : "0";

          // Handle video playback
          if (media.tagName === "VIDEO") {
            const video = media as HTMLVideoElement;
            if (isActive) {
              video.play().catch(() => {});
            } else {
              video.pause();
              try {
                video.currentTime = 0;
              } catch (e) {}
            }
          }
        });

        allCaptions.forEach((caption) => {
          const isActive = caption.dataset.captionIndex === mediaIndex;
          caption.style.opacity = isActive ? "1" : "0";
        });
      } else {
        trigger.setAttribute("aria-expanded", "false");
        if (targetContent) {
          targetContent.style.maxHeight = "0";
        }
        if (chevron) {
          chevron.style.transform = "rotate(0deg)";
        }
      }
    });
  });
</script>

<style>
  .accordion-content {
    transition: max-height 0.3s ease-out;
  }

  .accordion-chevron {
    transition: transform 0.2s ease-out;
  }

  .accordion-trigger:hover .accordion-chevron {
    color: #374151;
  }

  /* ensure media truly fills its parent */
  .accordion-media {
    position: absolute;
    inset: 0;
    display: block;
    width: 100%;
    height: 100%;
    transition: opacity 0.3s ease-in-out;
    object-fit: contain; /* change to 'cover' if you prefer cropping to fill */
  }

  .accordion-caption {
    transition: opacity 0.3s ease-in-out;
  }
</style>
